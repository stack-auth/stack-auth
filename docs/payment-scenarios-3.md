# Payments Purchase Scenarios

The table below summarizes how the payments APIs currently behave across the major customer states and purchase actions that appear in the implementation and tests.

| Customer state | Purchases recurring price | Purchases one-time price | Attempts duplicate of same product | Switches to different product in same catalog | Uses test-mode or direct API grant |
| --- | --- | --- | --- | --- | --- |
| **New user with no products and no include-by-default entitlements** | The purchase session validates the code, looks up the requested price, and creates a Stripe subscription; the code is revoked once a client secret is returned.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L29-L168】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L48-L61】 | One-time prices create a PaymentIntent with automatic payment methods, allow stackable quantities when configured, and immediately return the client secret.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L102-L127】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L63-L109】 | Because the customer has no previous records, the purchase is granted and recorded; stackability is enforced so non-stackable products still require quantity 1.【F:apps/backend/src/lib/payments.tsx†L445-L447】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L282-L299】 | Switching to a different product in an empty catalog simply provisions the new subscription after conflict checks pass, producing another client secret.【F:apps/backend/src/lib/payments.tsx†L493-L505】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L600-L666】 | Server-side grants can provision inline products without prior configuration, exposing them in listings for privileged callers.【F:apps/backend/src/lib/payments.tsx†L21-L69】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L355-L414】 |
| **New user when a catalog includes an include-by-default product** | Default catalog products are surfaced as active subscriptions before any purchase, but buying another recurring SKU in the catalog upgrades the existing Stripe subscription in-place.【F:apps/backend/src/lib/payments.tsx†L308-L331】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L49-L88】 | One-time products in the same catalog can be added alongside defaults because they do not conflict and simply mint a payment intent.【F:apps/backend/src/lib/payments.tsx†L493-L505】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L102-L127】 | Re-purchasing an include-by-default entry is blocked by the ProductAlreadyGranted guard since it is treated as an owned non-stackable product.【F:apps/backend/src/lib/payments.tsx†L465-L472】 | Upgrading to a priced product inside the catalog updates the Stripe subscription item for the active catalog entry, replacing the default.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L49-L88】 | API grants can still create additional stackable products, while default entitlements remain virtual subscriptions in listings.【F:apps/backend/src/lib/payments.tsx†L308-L349】【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L29-L82】 |
| **Customer already owns the exact product (subscription or one-time)** | Validation throws `PRODUCT_ALREADY_GRANTED` for non-stackable products, preventing duplicate subscriptions or grants.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L228-L284】 | Subsequent one-time purchases are also blocked because existing `one_time_purchase` rows trigger the same guard.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L770-L838】 | Duplicate server grants return the same `PRODUCT_ALREADY_GRANTED` error, aligning API and checkout behavior.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L228-L284】 | Attempting to “switch” to the same SKU simply fails the duplication checks, so the existing entitlement remains untouched.【F:apps/backend/src/lib/payments.tsx†L465-L472】 | Test-mode purchases respect persisted grants and will raise the duplication error even when the prior purchase was simulated.【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L770-L838】 |
| **Customer owns a different product in the same catalog** | The validator detects conflicting catalog subscriptions and either updates the existing Stripe subscription or cancels the stored DB subscription before creating the new one, ensuring a single active paid plan per catalog.【F:apps/backend/src/lib/payments.tsx†L493-L505】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L49-L100】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L561-L767】 | One-time prices with no interval bypass catalog conflicts and proceed, so a user can hold a recurring plan plus catalog-specific lifetime add-ons.【F:apps/backend/src/lib/payments.tsx†L493-L505】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L200-L238】 | Re-purchasing an equivalent plan through the API is prevented for non-stackable products, matching the checkout enforcement.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L228-L284】 | Switching plans triggers Stripe item updates when the old subscription has a Stripe ID, or DB cancellations for test-mode records, before issuing a new client secret.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L49-L100】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L561-L767】 | Test-mode upgrades within the same catalog cancel the simulated DB subscription so the subsequent live purchase can succeed.【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L668-L767】 |
| **Customer previously bought a one-time product in the catalog** | Recurring plans are allowed because the catalog conflict only applies to active subscriptions; the new plan replaces any conflicting subscription if needed.【F:apps/backend/src/lib/payments.tsx†L493-L505】 | Additional one-time SKUs in that catalog are rejected with a 400 “one-time purchase in this product catalog” message to prevent stacking mutually exclusive lifetime grants.【F:apps/backend/src/lib/payments.tsx†L482-L490】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L840-L905】 | Attempting to grant another one-time product through the API yields the same catalog-level rejection, keeping catalog entitlements exclusive.【F:apps/backend/src/lib/payments.tsx†L482-L490】 | Moving to a subscription still works because conflicts are handled at purchase time; the catalog retains only the latest active plan.【F:apps/backend/src/lib/payments.tsx†L493-L505】 | Test-mode purchases persist one-time grants, so later live runs see the catalog conflict and fail with the same error code.【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L840-L905】 |
| **Customer tries to buy an add-on without the base product** | Validation explicitly checks `isAddOnTo` and fails with a 400 if the customer lacks any of the required base subscriptions, so checkout never starts.【F:apps/backend/src/lib/payments.tsx†L474-L477】 | Stand-alone add-on one-time prices are blocked by the same guard until the prerequisite subscription exists.【F:apps/backend/src/lib/payments.tsx†L474-L477】 | API grants enforce the relationship too, returning the same status error when the dependency is missing.【F:apps/backend/src/lib/payments.tsx†L474-L477】 | Catalog switching is irrelevant because the add-on cannot be applied without satisfying the prerequisite, leaving existing plans untouched.【F:apps/backend/src/lib/payments.tsx†L474-L477】 | Test-mode grants respect the dependency and surface the same error path before any item quantities are adjusted.【F:apps/backend/src/lib/payments.tsx†L474-L477】 |
| **Customer receives server-only or inline products via API** | Server-only catalog entries stay hidden from client listings but remain visible to server callers, and grants require server/admin access.【F:apps/backend/src/lib/payments.tsx†L41-L44】【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L84-L141】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L136-L224】 | Inline one-time prices issued through the API create ledger entries without configuration, and clients still only see non-server-only products.【F:apps/backend/src/lib/payments.tsx†L45-L69】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L355-L414】 | Attempting to re-grant non-stackable inline products immediately returns the duplication error so inventory stays single-tenant.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L228-L284】 | Server-only products never appear in client catalogs, so “switching” via the UI is impossible; admins must revoke then re-grant as needed.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L29-L82】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L136-L224】 | Test-mode is not required—the API grant path inserts subscription or one-time rows directly and immediately updates listings.【F:apps/backend/src/lib/payments.tsx†L620-L700】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L61-L352】 |
| **Customer balances items via purchases and manual adjustments** | Subscriptions contribute repeating item grants according to their intervals and expiration policies, so recurring purchases continuously top up the ledger.【F:apps/backend/src/lib/payments.tsx†L145-L244】 | One-time purchases add permanent item grants when included items have no expiry, stacking with manual adjustments.【F:apps/backend/src/lib/payments.tsx†L171-L204】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/items.test.ts†L168-L255】 | Manual decrements are validated against the computed ledger balance, yielding insufficient quantity errors when the balance would go negative unless `allow_negative` is true.【F:apps/backend/src/lib/payments.tsx†L79-L143】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/items.test.ts†L297-L436】 | Switching catalog products updates which subscriptions feed the ledger, while expired adjustments automatically drop out of the balance.【F:apps/backend/src/lib/payments.tsx†L191-L243】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/items.test.ts†L210-L224】 | Test-mode subscriptions that include items immediately increment balances, and stackable quantities multiply the granted amount for the duration of the simulated subscription.【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L367-L559】 |
| **Invalid purchase attempts (bad code, price, quantity, or customer type)** | Invalid verification codes return `VERIFICATION_CODE_NOT_FOUND`, and wrong price IDs raise 400 errors before any Stripe call is made.【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L4-L46】【F:apps/backend/src/lib/payments.tsx†L438-L443】 | Non-stackable products reject quantities greater than one both in checkout and test-mode flows.【F:apps/backend/src/lib/payments.tsx†L445-L447】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L111-L299】 | Granting products to customers of the wrong type triggers explicit mismatch errors for both products and items.【F:apps/backend/src/lib/payments.tsx†L465-L477】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L438-L527】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/items.test.ts†L102-L138】 | Switching is disallowed because the session never reaches subscription mutation when validation fails; errors are returned immediately to the caller.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L29-L47】 | Test-mode endpoints share the same validation: disabled test mode yields 403, invalid codes return 404, and quantity/price errors mirror live behavior.【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L351-L486】 |

