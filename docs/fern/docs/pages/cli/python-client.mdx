---
title: Python CLI Client
description: How to use the Stack Auth CLI client with Python
---

# Stack Auth CLI Client

The Stack Auth CLI client allows you to authenticate with the Stack Auth API from the command line.

## Installation

```bash
pip install stack-auth-cli
```

## Usage

### Login

To log in to Stack Auth, use the `login` command:

```python
import requests

def stack_auth_request(method, endpoint, **kwargs):
  return requests.request(
    method,
    'https://api.stack-auth.com' + endpoint,
    headers={
      'x-stack-access-type': 'client',
      'x-stack-project-id': '<INSERT-YOUR-PROJECT-ID-HERE>',
      'x-stack-publishable-client-key': '<INSERT-YOUR-PUBLISHABLE-CLIENT-KEY-HERE>',
      **(kwargs.get('headers', {}) if 'headers' in kwargs else {}),
    },
    **{k: v for k, v in kwargs.items() if k != 'headers'},
  )

def prompt_cli_login():
  # Initiate CLI authentication
  init_response = stack_auth_request(
    'post',
    '/api/latest/auth/cli',
    json={}
  )
  
  if init_response.status_code != 200:
    print(f"Failed to initiate CLI authentication: {init_response.status_code}")
    return None
  
  data = init_response.json()
  polling_code = data['polling_code']
  login_code = data['login_code']
  
  # Open browser for user to complete authentication
  import webbrowser
  import os
  
  auth_url = f"https://app.stack-auth.com/cli-auth?login_code={login_code}"
  print(f"Opening browser to complete authentication at: {auth_url}")
  webbrowser.open(auth_url)
  
  # Poll for authentication status
  import time
  
  print("Waiting for authentication to complete...")
  while True:
    poll_response = stack_auth_request(
      'post',
      '/api/latest/auth/cli/poll',
      json={'polling_code': polling_code}
    )
    
    if poll_response.status_code not in [200, 201]:
      print(f"Failed to poll authentication status: {poll_response.status_code}")
      return None
    
    data = poll_response.json()
    status = data['status']
    
    if status == 'waiting':
      print(".", end="", flush=True)
      time.sleep(5)
      continue
    elif status == 'expired':
      print("\nAuthentication expired. Please try again.")
      return None
    elif status == 'used':
      print("\nThis authentication session has already been used.")
      return None
    elif status == 'success':
      print("\nAuthentication successful!")
      refresh_token = data['refresh_token']
      
      # Save refresh token to config file
      config_dir = os.path.expanduser("~/.stack-auth")
      os.makedirs(config_dir, exist_ok=True)
      
      with open(os.path.join(config_dir, "config.json"), "w") as f:
        import json
        json.dump({"refresh_token": refresh_token}, f)
      
      return refresh_token
    else:
      print(f"\nUnknown status: {status}")
      return None

# Example usage
refresh_token = prompt_cli_login()

# Below: example on how to use the refresh token with Stack Auth's API in Python

def get_user_object(refresh_token):
  # get access token (for faster performance, you'd only do this once every while)
  access_token_response = stack_auth_request(
    'post',
    '/api/v1/auth/sessions/current/refresh',
    headers={
      'x-stack-refresh-token': refresh_token,
    }
  )
  if access_token_response.status_code != 200:
    print("Failed to refresh access token", access_token_response.status_code, access_token_response.text)
    return None


  # fetch user object
  response = stack_auth_request(
    'get',
    '/api/v1/users/me',
    headers={
      'x-stack-access-token': access_token_response.json()['access_token'],
    }
  )
  if response.status_code == 200:
    return response.json()
  else:
    print('User is not authenticated', response.status_code, response.text)

print(get_user_object(refresh_token))
```

This will:
1. Initiate the CLI authentication process
2. Open your browser to complete the authentication
3. Poll the authentication status every 5 seconds
4. Save the refresh token to `~/.stack-auth/config.json` upon successful authentication

### Configuration

The CLI stores configuration in `~/.stack-auth/config.json`. This includes your refresh token after successful authentication.

### Environment Variables

- `STACK_AUTH_API_URL`: The base URL of the Stack Auth API. Defaults to `https://api.stack-auth.com`.
