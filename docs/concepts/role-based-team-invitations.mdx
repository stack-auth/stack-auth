# Role-Based Team Invitations

Stack Auth supports role-based team invitations, allowing you to assign specific permissions to users when inviting them to teams. This provides granular access control by letting you define exactly what permissions an invited user should have upon joining the team.

## Overview

Role-based team invitations extend the standard team invitation flow by adding the ability to:
- Select specific role-based permissions during the invitation process
- Apply these permissions automatically when the invitation is accepted
- Display assigned roles in the team management interface
- Provide better access control and permission management

## How It Works

### Backend API Changes

The team invitation system has been enhanced to support role-based permissions:

#### Send Team Invitation Endpoint

The `/team-invitations/send-code` endpoint now accepts an optional `permission_ids` parameter:

```typescript
POST /api/v1/team-invitations/send-code
{
  "email": "user@example.com",
  "team_id": "team-id",
  "callback_url": "https://app.example.com/team-invitation",
  "permission_ids": ["team_admin", "project_manager"] // Optional
}
```

#### Team Permissions Endpoint

The `/team-invitations/role-permissions` endpoint provides all available team permissions, including both role-based permissions and system permissions:

```typescript
GET /api/v1/team-invitations/role-permissions
```

Returns:
```json
{
  "items": [
    {
      "id": "team_admin",
      "description": "Team Administrator",
      "contained_permission_ids": ["$update_team", "$invite_members"]
    },
    {
      "id": "team_member",
      "description": "Team Member",
      "contained_permission_ids": ["$read_members"]
    },
    {
      "id": "$invite_members",
      "description": "Invite new members to the team",
      "contained_permission_ids": ["$invite_members"]
    },
    {
      "id": "$read_members",
      "description": "Read team member information",
      "contained_permission_ids": ["$read_members"]
    }
  ],
  "is_paginated": false
}
```

### Frontend Integration

#### Invitation Form with Role Selector

The team invitation form now includes a role selector dropdown:

```tsx
import { Team } from "@stackframe/stack";

function TeamInvitationForm({ team }: { team: Team }) {
  const [selectedRole, setSelectedRole] = useState('');
  
  const handleInvite = async (email: string) => {
    await team.inviteUser({ 
      email,
      permissionIds: selectedRole ? [selectedRole] : undefined
    });
  };
  
  return (
    <form>
      <input type="email" placeholder="Email" />
      <select onChange={(e) => setSelectedRole(e.target.value)}>
        <option value="">Default member role</option>
        <option value="team_admin">Team Administrator</option>
        <option value="project_manager">Project Manager</option>
      </select>
      <button type="submit">Invite User</button>
    </form>
  );
}
```

#### Updated Team Interface

The `Team` interface now supports the `permissionIds` parameter:

```typescript
interface Team {
  inviteUser(options: { 
    email: string; 
    callbackUrl?: string;
    permissionIds?: string[];
  }): Promise<void>;
}
```

## Configuration

### Defining Role-Based Permissions

Role-based permissions are defined in your Stack Auth project configuration:

```javascript
// stack-auth.config.js
export default {
  rbac: {
    permissions: {
      team_admin: {
        scope: "team",
        description: "Team Administrator",
        containedPermissionIds: {
          "$update_team": true,
          "$invite_members": true,
          "$remove_members": true,
          "$manage_api_keys": true
        }
      },
      project_manager: {
        scope: "team", 
        description: "Project Manager",
        containedPermissionIds: {
          "$read_members": true,
          "$invite_members": true
        }
      },
      team_viewer: {
        scope: "team",
        description: "Team Viewer", 
        containedPermissionIds: {
          "$read_members": true
        }
      }
    }
  }
};
```

### System vs Role-Based Permissions

Stack Auth distinguishes between two types of permissions:

- **System Permissions**: Built-in permissions prefixed with `$` (e.g., `$update_team`, `$invite_members`)
- **Role-Based Permissions**: Custom permissions defined in your configuration (e.g., `team_admin`, `project_manager`)

Both system and role-based permissions are now available for assignment during invitations, providing greater flexibility in team management.

## Permission Application

### During Invitation Acceptance

When a user accepts a team invitation with assigned permissions:

1. The user is added to the team with default member permissions
2. Additional role-based permissions specified in the invitation are granted
3. The user gains access according to their combined permissions

### Fallback Behavior

If no `permission_ids` are specified in the invitation:
- The user receives default member permissions as configured in your project
- Existing invitation behavior is preserved for backward compatibility

## User Interface Updates

### Team Member List

The team member list now displays assigned roles:

```
| User | Name | Role |
|------|------|------|
| üë§   | John Doe | Team Admin |
| üë§   | Jane Smith | Member |
```

### Pending Invitations

Outstanding invitations show the assigned role:

```
| Email | Expires | Role | Actions |
|-------|---------|------|---------|
| user@example.com | 2024-01-15 | Project Manager | üóëÔ∏è |
| admin@example.com | 2024-01-16 | Default | üóëÔ∏è |
```

## Security Considerations

### Permission Validation

- Only users with `$invite_members` permission can send team invitations
- All permissions (both role-based and system) are validated against your project configuration
- Invalid or non-existent permission IDs are rejected
- System permissions can now be directly assigned through invitations

### Access Control

- Role-based permissions follow the same inheritance rules as system permissions
- Permissions are applied immediately upon invitation acceptance
- Users retain default member permissions in addition to role-based permissions

## Migration Guide

### Existing Invitations

Existing team invitation code continues to work without changes:

```typescript
// This still works - users get default member permissions
await team.inviteUser({ email: "user@example.com" });
```

### Adding Role Selection

To add role selection to existing invitation forms:

1. Fetch available role-based permissions using the Stack Auth client
2. Add a role selector component to your invitation form
3. Pass selected `permissionIds` to the `inviteUser` method

```typescript
// Enhanced invitation with role selection
const permissions = await stackClient.getTeamRolePermissions({ session });
await team.inviteUser({ 
  email: "user@example.com",
  permissionIds: ["selected_role"]
});
```

## Best Practices

### Role Design

- Keep role-based permissions focused and minimal
- Use descriptive names and descriptions for roles
- Consider the principle of least privilege when designing roles
- Document the purpose and scope of each role

### User Experience

- Provide clear descriptions for each role in your UI
- Consider making role selection optional with sensible defaults
- Show current permissions/roles in team management interfaces
- Provide feedback when permissions are successfully applied

### Error Handling

- Handle cases where invalid permissions are selected
- Provide fallbacks when permission fetching fails  
- Show clear error messages for permission-related failures

## Limitations

- Role-based permissions must be pre-configured in your project
- System permissions cannot be directly assigned through invitations
- Permission changes only apply to new invitations, not existing ones
- Role display in the UI shows static labels (full dynamic role resolution requires additional API integration)

## API Reference

### Client Methods

```typescript
// Send team invitation with roles
await stackClient.sendTeamInvitation({
  email: string;
  teamId: string;
  callbackUrl: string;
  permissionIds?: string[];
  session: InternalSession;
});

// Fetch available role-based permissions
await stackClient.getTeamRolePermissions({
  session: InternalSession;
});
```

### Team Methods

```typescript
// Invite user with role assignment
await team.inviteUser({
  email: string;
  callbackUrl?: string;
  permissionIds?: string[];
});
```

This feature provides a foundation for sophisticated team access control while maintaining backward compatibility with existing Stack Auth applications.