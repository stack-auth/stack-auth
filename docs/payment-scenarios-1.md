# Payments Scenario Matrix

This matrix summarizes how the payments API responds across the major customer states and purchase mechanisms. Each cell captures the observable behavior today, based on the current handlers and end-to-end tests.

| Customer context | Subscription checkout (Stripe price) | One-time checkout | Test-mode checkout | Server/API grant | Item & entitlement impact |
| --- | --- | --- | --- | --- | --- |
| **New customer with no prior grants and no include-by-default products** | Creating a purchase URL confirms product/customer compatibility, provisions a Stripe customer, and issues a verification code; the purchase session then resolves the price, enforces quantity/stackability rules, and creates a Stripe subscription that returns a client secret for confirmation.【F:apps/backend/src/app/api/latest/payments/purchases/create-purchase-url/route.ts†L38-L95】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L29-L168】【F:apps/backend/src/lib/payments.tsx†L434-L447】 | After the same pre-flight validation, the purchase session detects the non-recurring price, enforces stackability, and creates a Payment Intent so the client receives a one-time client secret while metadata records the product grant.【F:apps/backend/src/lib/payments.tsx†L434-L447】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L102-L127】 | The internal test-mode endpoint requires test mode to be enabled, reuses the same validations, and directly records the subscription/one-time grant without hitting Stripe, returning success when complete.【F:apps/backend/src/app/api/latest/internal/payments/test-mode-purchase-session/route.tsx†L25-L57】【F:apps/backend/src/lib/payments.tsx†L564-L640】 | Server-side grants also reuse the shared validation and grant logic, so a single call will record the subscription or one-time purchase in the database with the configured quantity.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L86-L152】【F:apps/backend/src/lib/payments.tsx†L564-L640】 | Included items are tallied through the ledger logic—non-repeating, never-expiring items stay indefinitely, and repeating windows accumulate per billing interval; tests show test-mode grants immediately increment item balances.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L367-L437】 |
| **Customer inherits an include-by-default catalog product** | The subscription already exists virtually: catalog defaults are injected as active subscriptions, and there is no purchasable price, so attempting a checkout keeps `selectedPrice` undefined and the handler fails early instead of duplicating the grant.【F:apps/backend/src/lib/payments.tsx†L320-L349】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L45-L47】 | Without a price to purchase, one-time checkout is likewise impossible; the pre-validation phase returns no price, so the session aborts before any Payment Intent is created.【F:apps/backend/src/lib/payments.tsx†L434-L447】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L45-L47】 | Test-mode grants honor the same check: the shared grant helper sees no price data and simply treats the include-by-default access as already satisfied, returning success without altering records.【F:apps/backend/src/lib/payments.tsx†L603-L605】【F:apps/backend/src/app/api/latest/internal/payments/test-mode-purchase-session/route.tsx†L25-L57】 | Server/API grants behave the same way—calling the endpoint for an include-by-default entry passes validation but produces no additional subscription row beyond the implicit default.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L86-L152】【F:apps/backend/src/lib/payments.tsx†L603-L640】 | Because the entitlement already exists, item balances stay tied to the default subscription’s lifecycle; the ledger simply keeps the original windows active without double-counting.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/backend/src/lib/payments.tsx†L320-L349】 |
| **Customer already owns the same non-stackable product** | Validation detects an active subscription/one-time purchase for the same product and throws `PRODUCT_ALREADY_GRANTED`, so the Stripe checkout never begins.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L249-L283】 | The same guard blocks one-time attempts; the session returns a 400 with the `PRODUCT_ALREADY_GRANTED` error instead of issuing a Payment Intent.【F:apps/backend/src/lib/payments.tsx†L465-L472】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L825-L904】 | Test-mode grants reuse the validation helper, so the same error is surfaced before any database write in test mode.【F:apps/backend/src/lib/payments.tsx†L564-L600】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L825-L904】 | Server/API grants hit the same guard and respond with the known error, preventing duplicate entitlements.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L114-L152】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L249-L283】 | Because the operation aborts, no additional ledger entries are created and item balances remain unchanged.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/backend/src/lib/payments.tsx†L465-L472】 |
| **Customer has an active subscription in the same catalog (upgrade/downgrade case)** | Catalog conflicts are detected, and if the conflicting record has a Stripe subscription ID we update it in-place with the new price; DB-only conflicts are canceled before proceeding, so checkout continues with the refreshed subscription secret.【F:apps/backend/src/lib/payments.tsx†L493-L505】【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L49-L101】 | After conflicts are cleared, one-time purchases in the same catalog can proceed; tests show a DB-only subscription does not block the payment intent path, which still returns a client secret.【F:apps/backend/src/lib/payments.tsx†L493-L505】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L162-L238】 | Test-mode grants cancel the conflicting subscription record via the shared helper before inserting the new one, mirroring the production upgrade flow without contacting Stripe.【F:apps/backend/src/lib/payments.tsx†L589-L600】【F:apps/backend/src/app/api/latest/internal/payments/test-mode-purchase-session/route.tsx†L25-L57】 | Server/API grants follow the same pattern—`grantProductToCustomer` cancels the existing record (and Stripe subscription if present) before creating the new grant.【F:apps/backend/src/lib/payments.tsx†L589-L640】【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L114-L152】 | Because conflicts are resolved before the new grant, the ledger reflects only the latest active subscription, preventing duplicate windows for included items.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/backend/src/lib/payments.tsx†L589-L640】 |
| **Customer already bought a one-time product in the catalog** | Validation blocks the checkout with a 400, noting that the customer already owns a one-time product in the catalog, so no subscription client secret is ever issued.【F:apps/backend/src/lib/payments.tsx†L482-L490】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L888-L904】 | One-time attempts in the same catalog are also rejected for the same reason, preventing duplicate lifetime grants.【F:apps/backend/src/lib/payments.tsx†L482-L490】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L888-L904】 | Test-mode grants surface the same catalog-wide guard before writing anything, matching production behavior.【F:apps/backend/src/lib/payments.tsx†L564-L600】【F:apps/backend/src/app/api/latest/internal/payments/test-mode-purchase-session/route.tsx†L25-L57】 | Server/API grants respect the catalog guard, returning the same 400 error to the caller.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L114-L152】【F:apps/backend/src/lib/payments.tsx†L482-L490】 | Since the operation fails, the ledger keeps the original one-time quantity without change.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/backend/src/lib/payments.tsx†L482-L490】 |
| **Customer tries to buy an add-on without the required base product** | The shared validation rejects the checkout with a 400 because no qualifying base subscription exists, so no Stripe flow starts.【F:apps/backend/src/lib/payments.tsx†L474-L476】 | One-time add-ons are blocked by the same check, so the payment intent is never created.【F:apps/backend/src/lib/payments.tsx†L474-L476】 | Test-mode purchases are short-circuited by the same guard before any grant is recorded.【F:apps/backend/src/lib/payments.tsx†L564-L600】 | Server/API grants also error out before writing, ensuring add-ons cannot be granted in isolation.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L114-L152】【F:apps/backend/src/lib/payments.tsx†L474-L476】 | Because no grant occurs, there is no change to item balances or expirations.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/backend/src/lib/payments.tsx†L474-L476】 |
| **Customer requests quantity > 1 on a non-stackable product** | Validation raises a 400 (“This product is not stackable; quantity must be 1”), aborting the Stripe session; the behavior is covered by E2E tests.【F:apps/backend/src/lib/payments.tsx†L445-L447】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L111-L159】 | One-time purchases hit the same guard, returning the identical error when quantity exceeds one.【F:apps/backend/src/lib/payments.tsx†L445-L447】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L111-L159】 | Test-mode and inline grants reuse the validator, so the same error is raised in non-production flows.【F:apps/backend/src/lib/payments.tsx†L564-L600】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L240-L296】 | Server/API grants also reject the request, and the test suite covers the same failure case for direct grants.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L114-L152】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L286-L320】 | Since the grant is blocked, item balances do not change; stackable products with explicit quantity continue to work because they bypass this guard.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/products.test.ts†L286-L320】 |
| **Project is not in test mode but the test-mode checkout is used** | Subscription checkout is unaffected (it stays on the public Stripe flow), so this scenario is irrelevant to the subscription endpoint.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L29-L168】 | One-time checkout is also unaffected because it does not use the internal endpoint.【F:apps/backend/src/app/api/latest/payments/purchases/purchase-session/route.tsx†L102-L127】 | The internal endpoint returns a 403 (“Test mode is not enabled for this project”) and exits without granting anything, as verified by tests.【F:apps/backend/src/app/api/latest/internal/payments/test-mode-purchase-session/route.tsx†L29-L35】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L351-L365】 | Server/API grants remain available (they do not require test mode) and continue to function normally.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L86-L152】 | No ledger changes occur because the test-mode action was rejected.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/purchase-session.test.ts†L351-L365】 |
| **Client request uses mismatched customer type, server-only, or inline product from the client** | The purchase URL handler enforces customer-type alignment and rejects client-side inline/server-only requests with descriptive errors, preventing the checkout from starting.【F:apps/backend/src/app/api/latest/payments/purchases/create-purchase-url/route.ts†L41-L45】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/create-purchase-url.test.ts†L109-L197】 | Because the purchase URL never issues a verification code, one-time checkout cannot proceed in this misconfiguration.【F:apps/backend/src/app/api/latest/payments/purchases/create-purchase-url/route.ts†L38-L95】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/create-purchase-url.test.ts†L109-L197】 | The test-mode endpoint also depends on a valid verification code, so these requests fail before reaching it.【F:apps/backend/src/app/api/latest/internal/payments/test-mode-purchase-session/route.tsx†L25-L36】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/create-purchase-url.test.ts†L109-L197】 | Server/API grants can still succeed if the caller is authorized and the product is server-only, but they will throw the same mismatch error if the customer type is wrong.【F:apps/backend/src/app/api/latest/payments/products/[customer_type]/[customer_id]/route.ts†L114-L152】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/create-purchase-url.test.ts†L109-L197】 | With the grant blocked, the ledger has nothing to apply, so item balances remain unchanged.【F:apps/backend/src/lib/payments.tsx†L200-L239】【F:apps/e2e/tests/backend/endpoints/api/v1/payments/create-purchase-url.test.ts†L109-L197】 |

